<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Empenho de VTR</title>
  <style>
    /* --- Estilos CSS --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      min-height: 100vh;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
    }
    h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 20px;
      cursor: pointer;
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
    }
    button:hover { background: #0d47a1; transform: translateY(-2px); }
    button.danger { background: #d32f2f; }
    button.danger:hover { background: #b71c1c; }
    button.success { background: #388e3c; }
    button.success:hover { background: #2e7d32; }
    
    .table-container {
      overflow-x: auto;
      margin-bottom: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      max-height: 60vh; /* Limite de altura para a tabela */
      overflow-y: auto; /* Adiciona scroll vertical se a tabela for muito longa */
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    th {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 12px 8px;
      text-align: center;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    td {
      border: 1px solid #e0e0e0;
      padding: 8px;
      text-align: center;
      vertical-align: middle;
      white-space: nowrap;
    }
    tr:hover { background: #f5f5f5; }
    select, input {
      padding: 6px;
      width: 100%;
      border: 2px solid #e0e0e0;
      border-radius: 4px;
      font-size: 14px;
      transition: border 0.3s;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #1976d2;
    }
    
    .painel {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .painel h3 {
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
    }
    .card {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      transition: transform 0.3s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .card-unidade {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      align-items: flex-start;
      text-align: left;
    }
    .tag {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      margin: 3px;
      font-size: 0.8em;
      color: white;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      white-space: normal;
    }
    .section-title {
      font-weight: bold;
      margin-top: 10px;
      color: #424242;
      font-size: 0.9em;
    }
    .delete-btn {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .delete-btn:hover { background: #b71c1c; }
    
    .stats-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-box {
      background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .stat-box h4 { font-size: 14px; margin-bottom: 8px; opacity: 0.9; }
    .stat-box .number { font-size: 32px; font-weight: bold; }
    
    .filter-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .filter-section h4 { margin-bottom: 10px; color: #2c3e50; }
    .filter-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .filter-options select {
      flex: 1;
      min-width: 200px;
    }

    /* Estilos para o Modal */
    .modal-overlay {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.6); 
      z-index: 1000; 
      display: flex; 
      align-items: center; 
      justify-content: center;
    }
    .modal-content {
      background:white; 
      padding:30px; 
      border-radius:12px; 
      max-width:500px; 
      width:90%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-content h3 {
      margin-top:0;
      color: #1976d2;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>
    <span>üöì</span>
    Sistema de Controle de Empenho de VTR
  </h2>

  <div class="stats-summary">
    <div class="stat-box">
      <h4>Total de Registros</h4>
      <div class="number" id="totalRegistros">0</div>
    </div>
    <div class="stat-box" style="background: linear-gradient(135deg, #2196f3 0%, #42a5f5 100%);">
      <h4>VTRs Ativas</h4>
      <div class="number" id="totalVtrs">0</div>
    </div>
    <div class="stat-box" style="background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);">
      <h4>Unidades Ativas</h4>
      <div class="number" id="totalUnidades">0</div>
    </div>
  </div>

  <div class="filter-section">
    <h4>üîç Filtros</h4>
    <div class="filter-options">
      <select id="filtroUnidade" onchange="aplicarFiltros()">
        <option value="">Todas as Unidades</option>
      </select>
      <select id="filtroEmpenho" onchange="aplicarFiltros()">
        <option value="">Todos os Empenhos</option>
      </select>
      <button onclick="limparFiltros()">Limpar Filtros</button>
    </div>
  </div>

  <div class="controls">
    <button onclick="addRow()">‚ûï Adicionar Registro</button>
    <button class="success" onclick="exportarDados()">üì• Exportar CSV</button>
    <button class="danger" onclick="limparTudo()">üóëÔ∏è Limpar Tudo</button>
    <button style="background:#9c27b0" onclick="mostrarModalUnidade()">‚ûï Adicionar Unidade</button>
    <button style="background:#ff6f00" onclick="mostrarModalEmpenho()">‚ûï Adicionar Empenho (J)</button>
  </div>

  <div id="modalUnidade" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>‚ûï Adicionar Nova Unidade</h3>
      <input type="text" id="novaUnidade" placeholder="Nome da Unidade" style="width:100%; padding:10px; margin:10px 0; font-size:16px;">
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="adicionarUnidade()" style="flex:1;">Adicionar</button>
        <button onclick="fecharModalUnidade()" class="danger" style="flex:1;">Cancelar</button>
      </div>
    </div>
  </div>

  <div id="modalEmpenho" class="modal-overlay" style="display:none;">
    <div class="modal-content">
      <h3>‚ûï Adicionar Novo Empenho (J)</h3>
      <input type="text" id="novoEmpenhoCodigo" placeholder="C√≥digo (ex: J16)" style="width:100%; padding:10px; margin:10px 0; font-size:16px;">
      <input type="text" id="novoEmpenhoDescricao" placeholder="Descri√ß√£o do Empenho" style="width:100%; padding:10px; margin:10px 0; font-size:16px;">
      <label for="novoEmpenhoColor" style="display:block; margin-top:10px; font-weight:bold;">Cor da Tag:</label>
      <input type="color" id="novoEmpenhoColor" value="#1976d2" style="width:100%; padding:5px; margin:10px 0; height:50px;">
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button onclick="adicionarEmpenho()" style="flex:1;">Adicionar</button>
        <button onclick="fecharModalEmpenho()" class="danger" style="flex:1;">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="table-container">
    <table id="empenhoTable">
      <thead>
        <tr>
          <th>Unidade</th>
          <th>VTR</th>
          <th>Empenho</th>
          <th>Hor√°rio In√≠cio</th>
          <th>Hor√°rio Fim</th>
          <th>Tempo Decorrido</th>
          <th>Dura√ß√£o Total</th>
          <th>√öltimo J</th>
          <th>Protocolo</th>
          <th>Natureza</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="painel">
    <h3><span>üìä</span> Painel de Contagem por Empenho</h3>
    <div class="grid" id="contagemGrid"></div>
  </div>

  <div class="painel">
    <h3><span>üìå</span> Estat√≠stica por Unidade</h3>
    <div class="grid" id="unidadeGrid"></div>
  </div>

  <div class="painel">
    <h3><span>üöì</span> Estat√≠stica por VTR</h3>
    <div class="grid" id="vtrGrid"></div>
  </div>
</div>

<script>
// --- Vari√°veis Iniciais e Estruturas de Dados ---

let unidades = [
 "CPA NORTE (SEDE)", "6 CICOM", "13 CICOM", "15 CICOM", "18 CICOM", "26 CICOM", "27 CICOM",
 "CPA SUL (SEDE)", "1 CICOM", "2 CICOM", "3 CICOM", "7 CICOM", "24 CICOM",
 "CPA LESTE (SEDE)", "4 CICOM", "9 CICOM", "11 CICOM", "14 CICOM", "25 CICOM", "28 CICOM", "29 CICOM", "30 CICOM",
 "CPA OESTE (SEDE)", "5 CICOM", "8 CICOM", "19 CICOM", "20 CICOM", "21 CICOM",
 "CPA C. SUL/C. OESTE (SEDE)", "10 CICOM", "12 CICOM", "16 CICOM", "17 CICOM", "22 CICOM", "23 CICOM",
 "FT", "BPTRAN", "CPTUR", "RMP", "CICLO", "ROCAM", "CHOQUE", "MARTE", "RPMON", "CIPC√ÉES", "COE",
 "BPAMB", "CECOPOM", "GRAER", "BPG", "NPPM"
];

let empenhos = {
  "J1": "Atividade Fim",
  "J2": "Atividade administrativa",
  "J3": "Substitui√ß√£o de Guarni√ß√£o PM",
  "J4": "Refei√ß√£o",
  "J5": "Abastecimento",
  "J6": "Limpeza de viatura",
  "J7": "Manuten√ß√£o mec√¢nica",
  "J8": "Necessidades Fisiol√≥gicas",
  "J9": "Deslocamento para ocorr√™ncia",
  "J10": "Chegada no local da ocorr√™ncia",
  "J11": "Sa√≠da do local da ocorr√™ncia",
  "J12": "Guarni√ß√£o na base",
  "J15": "Opera√ß√£o Policial Militar"
};

let coresJ = {
  "J1": "#1b5e20", "J2": "#33691e", "J3": "#f57f17", "J4": "#ff6f00",
  "J5": "#e65100", "J6": "#bf360c", "J7": "#6a1b9a", "J8": "#4a148c",
  "J9": "#0d47a1", "J10": "#1565c0", "J11": "#0277bd", "J12": "#00838f",
  "J15": "#c2185b"
};

let registros = [];
let contagem = {}; // Contagem total por J
let contagemUnidade = {}; // Estat√≠stica por Unidade
let contagemVTR = {}; // Estat√≠stica por VTR

let unidadeFixa = null; 

// --- Fun√ß√µes de Persist√™ncia de Dados (localStorage) ---

function salvarDados() {
  localStorage.setItem('vtr_unidades', JSON.stringify(unidades));
  localStorage.setItem('vtr_empenhos', JSON.stringify(empenhos));
  localStorage.setItem('vtr_coresJ', JSON.stringify(coresJ));
  localStorage.setItem('vtr_registros', JSON.stringify(registros));
  localStorage.setItem('vtr_unidadeFixa', unidadeFixa);
}

function carregarDados() {
  const savedUnidades = localStorage.getItem('vtr_unidades');
  const savedEmpenhos = localStorage.getItem('vtr_empenhos');
  const savedCoresJ = localStorage.getItem('vtr_coresJ');
  const savedRegistros = localStorage.getItem('vtr_registros');
  const savedUnidadeFixa = localStorage.getItem('vtr_unidadeFixa');

  if (savedUnidades) unidades = JSON.parse(savedUnidades);
  if (savedEmpenhos) empenhos = JSON.parse(savedEmpenhos);
  if (savedCoresJ) coresJ = JSON.parse(savedCoresJ);
  if (savedUnidadeFixa !== 'null') unidadeFixa = savedUnidadeFixa;

  // Inicializa contagens
  for (let key in empenhos) contagem[key] = 0;
  unidades.forEach(u => contagemUnidade[u] = { total: 0, empenhos: {}, vtrs: [], protocolos: [], naturezas: [] });

  if (savedRegistros) {
    registros = JSON.parse(savedRegistros);
    // Transforma a data do formato de exibi√ß√£o 'dd/mm/yyyy hh:mm:ss' para o formato Date nativo
    // para garantir que o c√°lculo de tempo funcione em todos os navegadores
    registros.forEach(r => {
        if (r.horaInicio) r.horaInicio = formatarDataParaCalculo(r.horaInicio);
        if (r.horaFim) r.horaFim = formatarDataParaCalculo(r.horaFim);
    });
    reconstruirTabelaEContagens();
  }
}

// Fun√ß√µes de formata√ß√£o de data para garantir compatibilidade
function formatarDataParaExibicao(dataString) {
    if (!dataString) return '';
    try {
        const d = new Date(dataString);
        // Formata para 'dd/mm/yyyy hh:mm:ss'
        const datePart = d.toLocaleDateString('pt-BR'); 
        const timePart = d.toLocaleTimeString('pt-BR', { hour12: false });
        return `${datePart} ${timePart}`;
    } catch (e) {
        return dataString; // Retorna o original se houver erro
    }
}

function formatarDataParaCalculo(dataExibicao) {
    if (!dataExibicao || dataExibicao.includes('/')) {
        // Assume o formato 'dd/mm/yyyy hh:mm:ss' e reverte para 'yyyy-mm-dd hh:mm:ss' (ISO like)
        // para garantir que o new Date() funcione
        const parts = dataExibicao.split(' ');
        if (parts.length === 2) {
            const dateParts = parts[0].split('/');
            if (dateParts.length === 3) {
                return `${dateParts[2]}-${dateParts[1]}-${dateParts[0]} ${parts[1]}`;
            }
        }
    }
    return dataExibicao; // Retorna o original se j√° for um formato compat√≠vel
}

function calcularDuracao(inicio, fim) {
  if (!inicio || !fim) return '-';
  // Converte de volta para Date objects
  const d1 = new Date(formatarDataParaCalculo(inicio));
  const d2 = new Date(formatarDataParaCalculo(fim));
  const diff = Math.abs(d2 - d1) / 1000 / 60; // Diferen√ßa em minutos
  const horas = Math.floor(diff / 60);
  const mins = Math.floor(diff % 60);
  return `${horas}h ${mins}m`;
}

function calcularTempoDecorrido(inicio) {
  if (!inicio) return '-';
  const d1 = new Date(formatarDataParaCalculo(inicio));
  const agora = new Date();
  const diff = Math.abs(agora - d1) / 1000 / 60; // Diferen√ßa em minutos
  const horas = Math.floor(diff / 60);
  const mins = Math.floor(diff % 60);
  return `${horas}h ${mins}m`;
}

// Atualizar tempo decorrido a cada 10 segundos
setInterval(() => {
  const tbody = document.getElementById('empenhoTable').getElementsByTagName('tbody')[0];
  for (let i = 0; i < tbody.rows.length; i++) {
    const row = tbody.rows[i];
    const registro = registros[i];
    
    if (registro && registro.horaInicio && !registro.horaFim) {
      // row.cells[5] √© a c√©lula de Tempo Decorrido
      row.cells[5].innerText = calcularTempoDecorrido(registro.horaInicio);
    }
  }
}, 10000); // 10 segundos para atualiza√ß√£o

// --- Fun√ß√µes de Reconstru√ß√£o e Atualiza√ß√£o de UI ---

function reconstruirTabelaEContagens() {
  const tbody = document.getElementById('empenhoTable').getElementsByTagName('tbody')[0];
  tbody.innerHTML = '';
  
  // Limpa contagens para recalcul√°-las
  for (let key in contagem) contagem[key] = 0;
  unidades.forEach(u => contagemUnidade[u] = { total: 0, empenhos: {}, vtrs: [], protocolos: [], naturezas: [] });
  contagemVTR = {};
  
  registros.forEach((registro, index) => {
    // 1. Recalcula Contagens
    if (registro.ultimoJ && contagem[registro.ultimoJ] !== undefined) {
      contagem[registro.ultimoJ]++;
      const unidade = registro.unidade;
      const vtr = registro.vtr;
      const jCode = registro.ultimoJ;
      
      if (unidade && contagemUnidade[unidade]) {
        contagemUnidade[unidade].total++;
        if (!contagemUnidade[unidade].empenhos[jCode]) contagemUnidade[unidade].empenhos[jCode] = 0;
        contagemUnidade[unidade].empenhos[jCode]++;
        
        // VTRs na Unidade
        if (vtr && !contagemUnidade[unidade].vtrs.includes(vtr)) {
            contagemUnidade[unidade].vtrs.push(vtr);
        }

        // Protocolos e Naturezas
        if (registro.protocolo) {
            let protStr = `${jCode}-${registro.protocolo}`;
            // Adiciona apenas se for √∫nico para a unidade/empenho
            if (!contagemUnidade[unidade].protocolos.includes(protStr)) {
                contagemUnidade[unidade].protocolos.push(protStr);
            }
        }
        if (registro.natureza) {
            let natStr = `${jCode}-${registro.natureza}`;
             // Adiciona apenas se for √∫nico para a unidade/empenho
            if (!contagemUnidade[unidade].naturezas.includes(natStr)) {
                contagemUnidade[unidade].naturezas.push(natStr);
            }
        }
      }

      // 2. Calcula Contagem VTR
      if (vtr) {
        if (!contagemVTR[vtr]) {
          contagemVTR[vtr] = { total: 0, empenhos: {}, unidade: unidade };
        }
        contagemVTR[vtr].total++;
        if (!contagemVTR[vtr].empenhos[jCode]) contagemVTR[vtr].empenhos[jCode] = 0;
        contagemVTR[vtr].empenhos[jCode]++;
      }
    }
    
    // 3. Recria Linha na Tabela
    recreateRow(registro, index);
  });
  
  inicializarFiltros();
  atualizarEstatisticas();
  aplicarFiltros(); // Reaplicar filtros ap√≥s reconstru√ß√£o
  atualizarPainel();
  atualizarUnidadeGrid();
  atualizarVTRGrid();
}

function recreateRow(registro, index) {
  let table = document.getElementById("empenhoTable").getElementsByTagName("tbody")[0];
  let newRow = table.insertRow();

  // C√©lulas 0 a 10
  for (let i = 0; i <= 10; i++) newRow.insertCell(i);

  // 0. Unidade
  let selectUnidade = document.createElement("select");
  selectUnidade.innerHTML = '<option value="">Selecione...</option>';
  unidades.forEach(u => {
    let option = document.createElement("option");
    option.value = u; option.text = u;
    selectUnidade.appendChild(option);
  });
  selectUnidade.value = registro.unidade;
  selectUnidade.onchange = () => { 
    registros[index].unidade = selectUnidade.value; 
    if (!unidadeFixa && selectUnidade.value) unidadeFixa = selectUnidade.value;
    salvarDados();
    reconstruirTabelaEContagens(); // Recalcula tudo ao mudar a unidade
  };
  newRow.cells[0].appendChild(selectUnidade);

  // 1. VTR
  let inputVtr = document.createElement("input");
  inputVtr.placeholder = "Nome da VTR";
  inputVtr.value = registro.vtr;
  inputVtr.oninput = () => { 
      registros[index].vtr = inputVtr.value.toUpperCase(); 
      salvarDados(); 
      atualizarEstatisticas(); 
      reconstruirTabelaEContagens(); // Recalcula tudo para a VTR
  };
  newRow.cells[1].appendChild(inputVtr);

  // 2. Empenho (Select principal)
  let selectEmpenho = document.createElement("select");
  for (let key in empenhos) {
    let option = document.createElement("option");
    option.value = key; option.text = `${key} - ${empenhos[key]}`;
    selectEmpenho.appendChild(option);
  }
  selectEmpenho.value = registro.ultimoJ || 'J1'; 
  newRow.cells[2].appendChild(selectEmpenho);
  
  // Adiciona o EventListener para o Empenho (principal l√≥gica)
  selectEmpenho.addEventListener("change", function() {
    handleEmpenhoChange(newRow, index, selectUnidade, inputVtr, inputProtocolo, inputNatureza);
  });


  // 3. Hor√°rio in√≠cio (Exibi√ß√£o)
  newRow.cells[3].innerText = formatarDataParaExibicao(registro.horaInicio);

  // 4. Hor√°rio fim (Exibi√ß√£o)
  newRow.cells[4].innerText = formatarDataParaExibicao(registro.horaFim);

  // 5. Tempo Decorrido (atualizado pelo setInterval)
  newRow.cells[5].innerText = registro.horaFim ? "-" : calcularTempoDecorrido(registro.horaInicio);

  // 6. Dura√ß√£o Total (Calculada ao Finalizar)
  newRow.cells[6].innerText = calcularDuracao(registro.horaInicio, registro.horaFim);

  // 7. √öltimo J (Exibi√ß√£o)
  newRow.cells[7].innerText = registro.ultimoJ || 'J1';

  // 8. Protocolo
  let inputProtocolo = document.createElement("input");
  inputProtocolo.placeholder = "N¬∫ Protocolo";
  inputProtocolo.value = registro.protocolo || "";
  inputProtocolo.oninput = () => { registros[index].protocolo = inputProtocolo.value.toUpperCase(); salvarDados(); };
  newRow.cells[8].appendChild(inputProtocolo);

  // 9. Natureza
  let inputNatureza = document.createElement("input");
  inputNatureza.placeholder = "Natureza";
  inputNatureza.value = registro.natureza || "";
  inputNatureza.oninput = () => { registros[index].natureza = inputNatureza.value.toUpperCase(); salvarDados(); };
  newRow.cells[9].appendChild(inputNatureza);

  // 10. A√ß√µes
  let deleteBtn = document.createElement("button");
  deleteBtn.className = "delete-btn";
  deleteBtn.textContent = "üóëÔ∏è";
  deleteBtn.onclick = () => removerLinha(deleteBtn);
  newRow.cells[10].appendChild(deleteBtn);
}


// --- L√≥gica de Empenho Principal ---

function handleEmpenhoChange(row, index, selectUnidade, inputVtr, inputProtocolo, inputNatureza) {
    const now = new Date();
    // Armazena no formato nativo (ISO like) para c√°lculo, mas exibe o BR
    const dataHoraCalculo = now.toISOString();
    const newJ = row.cells[2].querySelector('select').value;
    
    // Atualiza Hor√°rios
    if (!registros[index].horaInicio || registros[index].horaFim) {
      // Come√ßa um novo registro de tempo
      registros[index].horaInicio = dataHoraCalculo;
      registros[index].horaFim = ''; // Garante que FIM est√° vazio
      
      row.cells[3].innerText = formatarDataParaExibicao(dataHoraCalculo); // Hor√°rio In√≠cio (Exibi√ß√£o)
      row.cells[4].innerText = ""; // Hor√°rio Fim (Exibi√ß√£o)
      row.cells[5].innerText = calcularTempoDecorrido(dataHoraCalculo); // Tempo Decorrido
      row.cells[6].innerText = "-"; // Dura√ß√£o Total
      
    } else {
      // Finaliza o registro de tempo
      registros[index].horaFim = dataHoraCalculo;

      row.cells[4].innerText = formatarDataParaExibicao(dataHoraCalculo); // Hor√°rio Fim (Exibi√ß√£o)
      row.cells[5].innerText = "-"; // Tempo Decorrido
      row.cells[6].innerText = calcularDuracao(registros[index].horaInicio, dataHoraCalculo); // Dura√ß√£o Total
    }
    
    // Atualiza J
    registros[index].ultimoJ = newJ;
    row.cells[7].innerText = newJ; // √öltimo J

    // For√ßa atualiza√ß√£o dos dados de entrada
    registros[index].unidade = selectUnidade.value;
    registros[index].vtr = inputVtr.value.trim().toUpperCase();
    registros[index].protocolo = inputProtocolo.value.trim().toUpperCase();
    registros[index].natureza = inputNatureza.value.trim().toUpperCase();
    
    // Recalcula todas as estat√≠sticas para garantir integridade
    reconstruirTabelaEContagens(); 
    salvarDados();
}

function atualizarEstatisticas() {
  const vtrsUnicas = new Set();
  const unidadesAtivas = new Set();
  
  registros.forEach(r => {
    if (r.vtr) vtrsUnicas.add(r.vtr);
    if (r.unidade) unidadesAtivas.add(r.unidade);
  });
  
  document.getElementById('totalRegistros').textContent = registros.length;
  document.getElementById('totalVtrs').textContent = vtrsUnicas.size;
  document.getElementById('totalUnidades').textContent = unidadesAtivas.size;
}

function atualizarPainel() {
  const grid = document.getElementById("contagemGrid");
  grid.innerHTML = "";
  for (let key in empenhos) {
    let card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <div style="font-size:16px;margin-bottom:5px">${key}</div>
      <div style="font-size:12px;opacity:0.8;margin-bottom:8px">${empenhos[key]}</div>
      <div style="font-size:28px;font-weight:bold;color:#1976d2">${contagem[key] || 0}</div>
    `;
    grid.appendChild(card);
  }
}

function atualizarUnidadeGrid() {
  const grid = document.getElementById("unidadeGrid");
  grid.innerHTML = "";
  for (let unidade in contagemUnidade) {
    if (contagemUnidade[unidade].total > 0) {
      let card = document.createElement("div");
      card.className = "card card-unidade";

      let listaEmpenhos = "";
      for (let e in contagemUnidade[unidade].empenhos) {
        
        // Protocolos e Naturezas espec√≠ficos do J na Unidade
        const protocolosDoEmpenho = contagemUnidade[unidade].protocolos
          .filter(p => p.startsWith(e + '-'))
          .map(p => p.split('-')[1])
          .filter(p => p); // Remove vazios
        
        const naturezasDoEmpenho = contagemUnidade[unidade].naturezas
          .filter(n => n.startsWith(e + '-'))
          .map(n => n.split('-')[1])
          .filter(n => n); // Remove vazios
        
        let detalhes = '';
        if (protocolosDoEmpenho.length > 0 || naturezasDoEmpenho.length > 0) {
          // Usa Set para obter valores √∫nicos
          const protUnicos = [...new Set(protocolosDoEmpenho)].join(', ');
          const natUnicas = [...new Set(naturezasDoEmpenho)].join(', ');

          detalhes = '<br><small style="font-size:0.75em; line-height:1.2; display:block; margin-top:3px;">';
          if (protUnicos) {
            detalhes += 'üìã P: ' + protUnicos;
          }
          if (natUnicas) {
            if (protUnicos) detalhes += '<br>';
            detalhes += 'üìù N: ' + natUnicas;
          }
          detalhes += '</small>';
        }
        
        listaEmpenhos += `<span class="tag" style="background:${coresJ[e] || '#607d8b'}; display:block; margin-bottom: 5px;">${e} (${contagemUnidade[unidade].empenhos[e]})${detalhes}</span> `;
      }

      // VTRs ativas na Unidade
      let listaVTRs = contagemUnidade[unidade].vtrs.map(v => 
        `<span class="tag" style="background:#64b5f6">${v}</span>`
      ).join(" ");

      card.innerHTML = `
        <strong style="font-size:16px;color:#1976d2;margin-bottom:8px;display:block">${unidade}</strong>
        <div style="font-size:14px;margin-bottom:5px">Total de Registros: <strong>${contagemUnidade[unidade].total}</strong></div>
        <div class="section-title">Empenhos:</div>
        <div style="margin:5px 0">${listaEmpenhos || '<em>Nenhum</em>'}</div>
        <div class="section-title">VTRs:</div>
        <div style="margin:5px 0">${listaVTRs || '<em>Nenhuma</em>'}</div>
      `;
      grid.appendChild(card);
    }
  }
}

function atualizarVTRGrid() {
  const grid = document.getElementById("vtrGrid");
  grid.innerHTML = "";
  
  for (let vtr in contagemVTR) {
    if (contagemVTR[vtr].total > 0) {
      let card = document.createElement("div");
      card.className = "card card-unidade";
      
      let listaEmpenhos = "";
      for (let e in contagemVTR[vtr].empenhos) {
        listaEmpenhos += `<span class="tag" style="background:${coresJ[e] || '#607d8b'}">${e} (${contagemVTR[vtr].empenhos[e]})</span> `;
      }
      
      card.innerHTML = `
        <strong style="font-size:16px;color:#1976d2;margin-bottom:8px;display:block">üöì ${vtr}</strong>
        <div style="font-size:14px;margin-bottom:5px">Total de Empenhos: <strong>${contagemVTR[vtr].total}</strong></div>
        <div class="section-title">Empenhos Registrados:</div>
        <div style="margin:5px 0">${listaEmpenhos || '<em>Nenhum</em>'}</div>
        <div class="section-title">Unidade:</div>
        <div style="margin:5px 0"><span class="tag" style="background:#ff9800">${contagemVTR[vtr].unidade || 'N/A'}</span></div>
      `;
      grid.appendChild(card);
    }
  }
}

function removerLinha(btn) {
  const row = btn.closest('tr');
  const index = row.rowIndex - 1; // -1 por causa do <thead>
  
  if (confirm('Deseja realmente remover este registro?')) {
    registros.splice(index, 1);
    row.remove();
    reconstruirTabelaEContagens(); // Recalcula tudo
    salvarDados();
  }
}

function addRow() {
  const newRowData = {
    unidade: unidadeFixa || '',
    vtr: '',
    ultimoJ: 'J1',
    horaInicio: '',
    horaFim: '',
    protocolo: '',
    natureza: ''
  };
  registros.push(newRowData);
  const index = registros.length - 1;

  recreateRow(newRowData, index);
  
  // Define a unidade inicial
  if (unidadeFixa) {
    const tableRow = document.getElementById("empenhoTable").getElementsByTagName("tbody")[0].rows[index];
    tableRow.cells[0].querySelector('select').value = unidadeFixa;
    registros[index].unidade = unidadeFixa;
  }
  
  salvarDados();
  atualizarEstatisticas();
}


// --- Fun√ß√µes de Modal e Filtro ---

function mostrarModalUnidade() { document.getElementById('modalUnidade').style.display = 'flex'; }
function fecharModalUnidade() { document.getElementById('modalUnidade').style.display = 'none'; document.getElementById('novaUnidade').value = ''; }
function adicionarUnidade() {
  const novaUnidade = document.getElementById('novaUnidade').value.trim().toUpperCase();
  if (novaUnidade && !unidades.includes(novaUnidade)) {
    unidades.push(novaUnidade);
    unidades.sort(); // Opcional: manter em ordem alfab√©tica
    contagemUnidade[novaUnidade] = { total: 0, empenhos: {}, vtrs: [], protocolos: [], naturezas: [] };
    salvarDados();
    inicializarFiltros();
    alert(`Unidade "${novaUnidade}" adicionada com sucesso!`);
    fecharModalUnidade();
    reconstruirTabelaEContagens(); 
  } else if (unidades.includes(novaUnidade)) { alert('Esta unidade j√° existe!'); } else { alert('Digite o nome da unidade!'); }
}

function mostrarModalEmpenho() { document.getElementById('modalEmpenho').style.display = 'flex'; }
function fecharModalEmpenho() { document.getElementById('modalEmpenho').style.display = 'none'; document.getElementById('novoEmpenhoCodigo').value = ''; document.getElementById('novoEmpenhoDescricao').value = ''; document.getElementById('novoEmpenhoColor').value = '#1976d2'; }
function adicionarEmpenho() {
  const codigo = document.getElementById('novoEmpenhoCodigo').value.trim().toUpperCase();
  const descricao = document.getElementById('novoEmpenhoDescricao').value.trim();
  const cor = document.getElementById('novoEmpenhoColor').value;
  
  if (codigo && descricao && !empenhos[codigo]) {
    empenhos[codigo] = descricao;
    coresJ[codigo] = cor;
    contagem[codigo] = 0;
    salvarDados();
    inicializarFiltros();
    alert(`Empenho "${codigo} - ${descricao}" adicionado com sucesso!`);
    fecharModalEmpenho();
    reconstruirTabelaEContagens(); // Atualiza a tabela com o novo empenho
  } else if (empenhos[codigo]) { alert('Este c√≥digo de empenho j√° existe!'); } else { alert('Preencha todos os campos!'); }
}

function inicializarFiltros() {
  const filtroUnidade = document.getElementById('filtroUnidade');
  const filtroEmpenho = document.getElementById('filtroEmpenho');
  
  // Limpa e repopula Unidade
  filtroUnidade.innerHTML = '<option value="">Todas as Unidades</option>';
  unidades.forEach(u => {
    const opt = document.createElement('option');
    opt.value = u; opt.text = u;
    filtroUnidade.appendChild(opt);
  });
  
  // Limpa e repopula Empenho
  filtroEmpenho.innerHTML = '<option value="">Todos os Empenhos</option>';
  for (let key in empenhos) {
    const opt = document.createElement('option');
    opt.value = key;
    opt.text = `${key} - ${empenhos[key]}`;
    filtroEmpenho.appendChild(opt);
  }
}

function aplicarFiltros() {
  const filtroU = document.getElementById('filtroUnidade').value;
  const filtroE = document.getElementById('filtroEmpenho').value;
  const tbody = document.getElementById('empenhoTable').getElementsByTagName('tbody')[0];
  
  for (let i = 0; i < tbody.rows.length; i++) {
    const row = tbody.rows[i];
    const registro = registros[i];
    
    // Pega os valores do registro (ou da c√©lula, se preferir):
    const unidade = registro.unidade;
    const empenho = registro.ultimoJ;
    
    let mostrar = true;
    if (filtroU && unidade !== filtroU) mostrar = false;
    if (filtroE && empenho !== filtroE) mostrar = false;
    
    row.style.display = mostrar ? '' : 'none';
  }
}

function limparFiltros() {
  document.getElementById('filtroUnidade').value = '';
  document.getElementById('filtroEmpenho').value = '';
  aplicarFiltros();
}

function exportarDados() {
    let csvContent = "data:text/csv;charset=utf-8,\uFEFF"; // \uFEFF for BOM (better excel compatibility)
    csvContent += "Unidade;VTR;Empenho;Hor√°rio In√≠cio;Hor√°rio Fim;Dura√ß√£o Total;Protocolo;Natureza\n";

    registros.forEach(r => {
        const row = [
            r.unidade || '',
            r.vtr || '',
            `${r.ultimoJ} - ${empenhos[r.ultimoJ]}` || '',
            formatarDataParaExibicao(r.horaInicio) || '',
            formatarDataParaExibicao(r.horaFim) || '',
            calcularDuracao(r.horaInicio, r.horaFim) || '',
            r.protocolo || '',
            r.natureza || ''
        ].join(";");
        csvContent += row + "\n";
    });

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `EmpenhoVTR_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.csv`);
    document.body.appendChild(link); // Required for Firefox
    link.click();
    document.body.removeChild(link);
}

function limparTudo() {
  if (confirm('ATEN√á√ÉO: Isso ir√° apagar *TODOS* os dados, incluindo unidades e empenhos customizados, e n√£o poder√° ser desfeito. Deseja continuar?')) {
    localStorage.clear();
    location.reload(); // Recarrega a p√°gina para resetar as vari√°veis JS aos valores iniciais
  }
}

// Inicializa√ß√£o
carregarDados();
</script>

</body>
</html>
